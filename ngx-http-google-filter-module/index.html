<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    
        <title>無名小站</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="description" content="配上免費的 letsencrypt SSL/TLS 證書，一個個安全快速的谷歌又出現了。
作為 letsencrypt 的 MAJOR SPONSORS ，可以試試看這個開源的項目。">
<meta property="og:type" content="article">
<meta property="og:title" content="牆內Google開">
<meta property="og:url" content="https://ky0n.xyz/ngx-http-google-filter-module/index.html">
<meta property="og:site_name" content="無名小站">
<meta property="og:description" content="配上免費的 letsencrypt SSL/TLS 證書，一個個安全快速的谷歌又出現了。
作為 letsencrypt 的 MAJOR SPONSORS ，可以試試看這個開源的項目。">
<meta property="og:image" content="https://o3ziuzht9.qnssl.com/wenlu.png">
<meta property="og:updated_time" content="2016-03-14T06:36:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="牆內Google開">
<meta name="twitter:description" content="配上免費的 letsencrypt SSL/TLS 證書，一個個安全快速的谷歌又出現了。
作為 letsencrypt 的 MAJOR SPONSORS ，可以試試看這個開源的項目。">
<meta name="twitter:image" content="https://o3ziuzht9.qnssl.com/wenlu.png">
            
                    <link rel="icon" href="../favicon.ico">
                    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
                    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
                    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
                    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
                    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
                    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
                    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
                    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
                    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
                    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
                    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
                    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
                    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
                    <link rel="manifest" href="/manifest.json">
                    <meta name="msapplication-TileColor" content="#ffffff">
                    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
                    <meta name="theme-color" content="#ffffff">
                    <meta name="google" content="notranslate">
                    <link rel="stylesheet" href="/css/style.css">
                        <style type="text/css">
                            html {
                                background-color: white
                            }
                        </style>
                        <script language="JavaScript">
                            function check_secure() {
                                var httpsRE = /^https/i;
                                if (!window.location.origin.match(httpsRE)) {
                                    window.location = "https://" + window.location.hostname + window.location.pathname + window.location.search;
                                }
                            }
                            check_secure();
                        </script>
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
      </h1>
      
      <div id="rss-wrap">
      
      
      </div>
    </div>
  </div>
  <div id="header-inner" class="">
    <a class="title"></a>
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
    </nav>
    <nav id="sub-nav">
      <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
    </nav>
    <div id="search-form-wrap">
      <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ky0n.xyz"></form>
    </div>
    <div id="sub-profile">
    </div>
  </div>
  <div class="site-nav">
    <ul>
    
      <li>
        <a href="/">首頁</a>
      </li>
    
      <li>
        <a href="/archives">過往</a>
      </li>
    
      <li>
        <a href="/friends">摯友</a>
      </li>
    
      <li>
        <a href="/atom.xml">訂閱</a>
      </li>
    
      <li>
        <a href="/about">關於</a>
      </li>
    
    </ul>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-ngx-http-google-filter-module" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/ngx-http-google-filter-module/" class="article-date">
  <!--<time datetime="2016-03-10T14:51:29.000Z" itemprop="datePublished">2016-03-10</time>-->
</a>

    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      牆內Google開
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://o3ziuzht9.qnssl.com/wenlu.png" alt=""></p>
<p>配上免費的 <a href="https://letsencrypt.org/" target="_blank" rel="external">letsencrypt</a> SSL/TLS 證書，一個個安全快速的谷歌又出現了。</p>
<p>作為 letsencrypt 的 MAJOR SPONSORS ，可以試試看這個開源的項目。</p>
<a id="more"></a>
<h4 id="依賴庫"><a href="#依賴庫" class="headerlink" title="依賴庫"></a>依賴庫</h4><ol>
<li><a href="http://www.pcre.org/" target="_blank" rel="external"><code>pcre</code></a> <em>正則</em></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="external"><code>ngx_http_proxy_module</code></a> <em>反向代理</em></li>
<li><a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module" target="_blank" rel="external"><code>ngx_http_substitutions_filter_module</code></a> <em>多重替換</em></li>
</ol>
<h4 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h4><blockquote>
<p><strong>以 ubuntu 14.04 爲例</strong><br><em>i386, x86_64 均適用</em></p>
</blockquote>
<h5 id="最簡安裝"><a href="#最簡安裝" class="headerlink" title="最簡安裝"></a>最簡安裝</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 安裝 gcc &amp; git</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apt-get install build-essential git gcc g++ make</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載最新版源碼</span></span><br><span class="line"><span class="comment"># nginx 官網:</span></span><br><span class="line"><span class="comment"># http://nginx.org/en/download.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">wget <span class="string">"http://nginx.org/download/nginx-1.9.12.tar.gz"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載最新版 pcre</span></span><br><span class="line"><span class="comment"># pcre 官網:</span></span><br><span class="line"><span class="comment"># http://www.pcre.org/</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">wget <span class="string">"ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.38.tar.gz"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載最新版 openssl</span></span><br><span class="line"><span class="comment"># opessl 官網:</span></span><br><span class="line"><span class="comment"># https://www.openssl.org/</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">wget <span class="string">"https://www.openssl.org/source/openssl-1.0.1s.tar.gz"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載最新版 zlib</span></span><br><span class="line"><span class="comment"># zlib 官網:</span></span><br><span class="line"><span class="comment"># http://www.zlib.net/</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">wget <span class="string">"http://zlib.net/zlib-1.2.8.tar.gz"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載本擴展</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/cuber/ngx_http_google_filter_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載 substitutions 擴展</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yaoweibin/ngx_http_substitutions_filter_module</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 解壓縮</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">tar xzvf nginx-1.9.12.tar.gz</span><br><span class="line">tar xzvf pcre-8.38.tar.gz</span><br><span class="line">tar xzvf openssl-1.0.1s.tar.gz</span><br><span class="line">tar xzvf zlib-1.2.8.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 進入 nginx 源碼目錄</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cd</span> nginx-1.9.12</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 設置編譯選項</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">./configure \</span><br><span class="line">  --prefix=/opt/nginx-1.9.12 \</span><br><span class="line">  --with-pcre=../pcre-8.38 \</span><br><span class="line">  --with-openssl=../openssl-1.0.1s \</span><br><span class="line">  --with-zlib=../zlib-1.2.8 \</span><br><span class="line">  --with-http_ssl_module \</span><br><span class="line">  --with-ipv6 \</span><br><span class="line">  --with-http_v2_module \</span><br><span class="line">  --add-module=../ngx_http_google_filter_module \</span><br><span class="line">  --add-module=../ngx_http_substitutions_filter_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 編譯, 安裝</span></span><br><span class="line"><span class="comment"># 如果擴展有報錯, 請發 issue 到</span></span><br><span class="line"><span class="comment"># https://github.com/cuber/ngx_http_google_filter_module/issues</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 啓動, 安裝過程到此結束</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">sudo /opt/nginx-1.9.12/sbin/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 配置修改後, 需要 reload nginx 來讓配置生效,</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">sudo /opt/nginx-1.9.12/sbin/nginx <span class="_">-s</span> reload</span><br></pre></td></tr></table></figure>
<h5 id="從發行版遷移"><a href="#從發行版遷移" class="headerlink" title="從發行版遷移"></a>從發行版遷移</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 安裝 gcc &amp; git</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apt-get install build-essential git gcc g++ make</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 安裝發行版</span></span><br><span class="line"><span class="comment"># (已安裝的請忽略)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apt-get install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 查看發行版編譯選項及版本</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">nginx -V</span><br><span class="line"><span class="comment"># nginx version: nginx/1.4.7</span></span><br><span class="line"><span class="comment"># built by gcc 4.8.2 (Ubuntu 4.8.2-19ubuntu1)</span></span><br><span class="line"><span class="comment"># TLS SNI support enabled</span></span><br><span class="line"><span class="comment"># configure arguments:</span></span><br><span class="line"><span class="comment">#  --with-cc-opt='-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2' \</span></span><br><span class="line"><span class="comment">#  --with-ld-opt='-Wl,-Bsymbolic-functions -Wl,-z,relro' \</span></span><br><span class="line"><span class="comment">#  --prefix=/usr/share/nginx \</span></span><br><span class="line"><span class="comment">#  --conf-path=/etc/nginx/nginx.conf \</span></span><br><span class="line"><span class="comment">#  --http-log-path=/var/log/nginx/access.log \</span></span><br><span class="line"><span class="comment">#  --error-log-path=/var/log/nginx/error.log \</span></span><br><span class="line"><span class="comment">#  --lock-path=/var/lock/nginx.lock \</span></span><br><span class="line"><span class="comment">#  --pid-path=/run/nginx.pid \</span></span><br><span class="line"><span class="comment">#  --http-client-body-temp-path=/var/lib/nginx/body \</span></span><br><span class="line"><span class="comment">#  --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span></span><br><span class="line"><span class="comment">#  --http-proxy-temp-path=/var/lib/nginx/proxy \</span></span><br><span class="line"><span class="comment">#  --http-scgi-temp-path=/var/lib/nginx/scgi \</span></span><br><span class="line"><span class="comment">#  --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span></span><br><span class="line"><span class="comment">#  --with-debug \</span></span><br><span class="line"><span class="comment">#  --with-pcre-jit \</span></span><br><span class="line"><span class="comment">#  --with-ipv6 \</span></span><br><span class="line"><span class="comment">#  --with-http_ssl_module \</span></span><br><span class="line"><span class="comment">#  --with-http_stub_status_module \</span></span><br><span class="line"><span class="comment">#  --with-http_realip_module \</span></span><br><span class="line"><span class="comment">#  --with-http_addition_module \</span></span><br><span class="line"><span class="comment">#  --with-http_dav_module \</span></span><br><span class="line"><span class="comment">#  --with-http_geoip_module \</span></span><br><span class="line"><span class="comment">#  --with-http_gzip_static_module \</span></span><br><span class="line"><span class="comment">#  --with-http_image_filter_module \</span></span><br><span class="line"><span class="comment">#  --with-http_spdy_module \</span></span><br><span class="line"><span class="comment">#  --with-http_sub_module \</span></span><br><span class="line"><span class="comment">#  --with-http_xslt_module \</span></span><br><span class="line"><span class="comment">#  --with-mail \</span></span><br><span class="line"><span class="comment">#  --with-mail_ssl_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載對應 nginx 大版本</span></span><br><span class="line"><span class="comment"># nginx 官網:</span></span><br><span class="line"><span class="comment"># http://nginx.org/en/download.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">wget <span class="string">"http://nginx.org/download/nginx-1.4.7.tar.gz"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載本擴展</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/cuber/ngx_http_google_filter_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 下載 substitutions 擴展</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yaoweibin/ngx_http_substitutions_filter_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 安裝依賴庫的 dev 包</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apt-get install libpcre3-dev libssl-dev zlib1g-dev libxslt1-dev libgd-dev libgeoip-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 請對照自己發行版的 configure 參數進行 configure, 勿直接 copy 以下配置</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">./configure \</span><br><span class="line">  --with-cc-opt=<span class="string">'-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2'</span> \</span><br><span class="line">  --with-ld-opt=<span class="string">'-Wl,-Bsymbolic-functions -Wl,-z,relro'</span> \</span><br><span class="line">  --prefix=/usr/share/nginx \</span><br><span class="line">  --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">  --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">  --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">  --lock-path=/var/lock/nginx.lock \</span><br><span class="line">  --pid-path=/run/nginx.pid \</span><br><span class="line">  --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">  --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">  --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">  --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">  --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">  --with-debug \</span><br><span class="line">  --with-pcre-jit \</span><br><span class="line">  --with-ipv6 \</span><br><span class="line">  --with-http_ssl_module \</span><br><span class="line">  --with-http_stub_status_module \</span><br><span class="line">  --with-http_realip_module \</span><br><span class="line">  --with-http_addition_module \</span><br><span class="line">  --with-http_dav_module \</span><br><span class="line">  --with-http_geoip_module \</span><br><span class="line">  --with-http_gzip_static_module \</span><br><span class="line">  --with-http_image_filter_module \</span><br><span class="line">  --with-http_spdy_module \</span><br><span class="line">  --with-http_sub_module \</span><br><span class="line">  --with-http_xslt_module \</span><br><span class="line">  --with-mail \</span><br><span class="line">  --with-mail_ssl_module \</span><br><span class="line">  --with-http_v2_module \</span><br><span class="line">  --add-module=../ngx_http_google_filter_module \</span><br><span class="line">  --add-module=../ngx_http_substitutions_filter_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 覆蓋二進制文件</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">cp -rf objs/nginx /usr/sbin/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 重啓 nginx 至此, 遷移工作結束</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">service nginx stop</span><br><span class="line">service nginx start</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 配置修改後, 需要 restart nginx 來讓配置生效</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">service nginx restart</span><br></pre></td></tr></table></figure>
<h4 id="基本配置方法"><a href="#基本配置方法" class="headerlink" title="基本配置方法"></a>基本配置方法</h4><p><code>http</code>配置方式<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">server_name</span> &lt;你的域名&gt;;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>https</code>配置方式<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">server_name</span> &lt;你的域名&gt;;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> &lt;你的證書路徑&gt;;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> &lt;你的私鑰路徑&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>免費的 letsencrypt 證書簽發教程請移至文章末尾</p>
</blockquote>
<h4 id="進階配置方法"><a href="#進階配置方法" class="headerlink" title="進階配置方法"></a>進階配置方法</h4><h5 id="基本搜索"><a href="#基本搜索" class="headerlink" title="基本搜索"></a>基本搜索</h5><p>需要配置 <code>resolver</code> 用於域名解析<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># ... 僅列舉部分配置</span></span><br><span class="line">  <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="谷歌學術"><a href="#谷歌學術" class="headerlink" title="谷歌學術"></a>谷歌學術</h5><p><code>google_scholar</code> 依賴於 <code>google</code>, 所以 <code>google_scholar</code> 無法獨立使用.<br>由於谷歌學術近日升級, 強制使用 <code>https</code> 協議, 並且 <code>ncr</code> 已經支持, 所以不再需要指定谷歌學術的 <code>tld</code><br>配置 nginx<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">google_scholar</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="默認語言偏好"><a href="#默認語言偏好" class="headerlink" title="默認語言偏好"></a>默認語言偏好</h5><p>默認的語言偏好可用 <code>google_language</code> 來設置, 如果沒有設置, 默認使用 <code>zh-CN</code> (中文)<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">google_scholar</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment"># 設置成德文</span></span><br><span class="line">  <span class="attribute">google_language</span> <span class="string">"de"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>支持的語言如下.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ar    -&gt; 阿拉伯</span><br><span class="line">bg    -&gt; 保加利亞</span><br><span class="line">ca    -&gt; 加泰羅尼亞</span><br><span class="line">zh-CN -&gt; 中國 (簡體)</span><br><span class="line">zh-TW -&gt; 中國 (繁體)</span><br><span class="line">hr    -&gt; 克羅地亞</span><br><span class="line">cs    -&gt; 捷克</span><br><span class="line">da    -&gt; 丹麥</span><br><span class="line">nl    -&gt; 荷蘭</span><br><span class="line">en    -&gt; 英語</span><br><span class="line">tl    -&gt; 菲律賓</span><br><span class="line">fi    -&gt; 芬蘭</span><br><span class="line">fr    -&gt; 法國</span><br><span class="line">de    -&gt; 德國</span><br><span class="line">el    -&gt; 希臘</span><br><span class="line">iw    -&gt; 希伯來</span><br><span class="line">hi    -&gt; 印地文</span><br><span class="line">hu    -&gt; 匈牙利</span><br><span class="line">id    -&gt; 印度尼西亞</span><br><span class="line">it    -&gt; 意大利</span><br><span class="line">ja    -&gt; 日本</span><br><span class="line">ko    -&gt; 朝鮮</span><br><span class="line">lv    -&gt; 拉脫維亞</span><br><span class="line">lt    -&gt; 立陶宛</span><br><span class="line">no    -&gt; 挪威</span><br><span class="line">fa    -&gt; 波斯</span><br><span class="line">pl    -&gt; 波蘭</span><br><span class="line">pt-BR -&gt; 葡萄牙 (巴西)</span><br><span class="line">pt-PT -&gt; 葡萄牙 (葡萄牙)</span><br><span class="line">ro    -&gt; 羅馬尼亞</span><br><span class="line">ru    -&gt; 俄羅斯</span><br><span class="line">sr    -&gt; 塞爾維亞</span><br><span class="line">sk    -&gt; 斯洛伐克</span><br><span class="line">sl    -&gt; 斯洛文尼亞</span><br><span class="line">es    -&gt; 西班牙</span><br><span class="line">sv    -&gt; 瑞典</span><br><span class="line">th    -&gt; 泰國</span><br><span class="line">tr    -&gt; 土耳其</span><br><span class="line">uk    -&gt; 烏克蘭</span><br><span class="line">vi    -&gt; 越南</span><br></pre></td></tr></table></figure></p>
<h5 id="搜索引擎爬蟲許可"><a href="#搜索引擎爬蟲許可" class="headerlink" title="搜索引擎爬蟲許可"></a>搜索引擎爬蟲許可</h5><p>任何搜索引擎爬蟲都不被允許爬取 google 鏡像<br>如下的默認 <code>robots.txt</code> 已經內置.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /</span><br></pre></td></tr></table></figure></p>
<p>如果想要使用 <code>google</code> 自己的 <code>robots.txt</code> 請將 <code>google_robots_allow</code> 設爲 <code>on</code><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">google_robots_allow</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure></p>
<h5 id="Upstreaming"><a href="#Upstreaming" class="headerlink" title="Upstreaming"></a>Upstreaming</h5><p><code>upstream</code> 減少一次域名解析的開銷, 並且通過配置多個網段的 google ip 能夠一定程度上減少被 google 機器人識別程序偵測到的機率 (彈驗證碼).<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以通過如下方法獲取 google ip</span></span><br><span class="line">➜  ~  dig www.google.com @8.8.8.8 +short</span><br><span class="line">173.194.38.209</span><br><span class="line">173.194.38.211</span><br><span class="line">173.194.38.212</span><br><span class="line">173.194.38.210</span><br><span class="line">173.194.38.208</span><br></pre></td></tr></table></figure></p>
<p>然後將獲取到的 ip 配置如下即可<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> www.google.com &#123;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">173.194.38.209:443</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">173.194.38.211:443</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">173.194.38.212:443</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">173.194.38.210:443</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">173.194.38.208:443</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Proxy-Protocal"><a href="#Proxy-Protocal" class="headerlink" title="Proxy Protocal"></a>Proxy Protocal</h5><p>默認採用 <code>https</code> 與後端服務器通信.<br>你可以使用 <code>google_ssl_off</code> 來強制將一些域降到 <code>http</code> 協議.<br>這個設置可以讓一些需要二次轉發的域通過 <code>http</code> 協議進行轉發, 從而不再依賴 <code>ssl</code> 證書.<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 例如 'www.google.com' 按如下方式代理</span></span><br><span class="line"><span class="comment"># vps(hk) -&gt; vps(us) -&gt; google</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># vps(hk) 配置</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">google</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">google_ssl_off</span> <span class="string">"www.google.com"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">upstream</span> www.google.com &#123;</span><br><span class="line">  <span class="attribute">server</span> &lt; vps(us) 的 ip &gt;:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># vps(us) 配置</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> www.google.com;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://www.google.com;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>cloudxns DNS 驗證方式快速獲取 lets-encrypt 證書的 shell 腳本</p>
<p><a href="https://github.com/xdtianyu/scripts/tree/master/le-dns" target="_blank" rel="external">https://github.com/xdtianyu/scripts/tree/master/le-dns</a></p>
<p>腳本基於 letsencrypt.sh，通過調用 cloudxns API 更新 TXT 記錄用於認證，實現快速獲取 lets-encrypt 證書。無需 root 權限，無需指定網站目錄及 DNS 解析</p>
<p>下載</p>
<pre><code>wget https://github.com/xdtianyu/scripts/raw/master/le-dns/le-cloudxns.sh
wget https://github.com/xdtianyu/scripts/raw/master/le-dns/cloudxns.conf
chmod +x le-cloudxns.sh
</code></pre><p>配置</p>
<p>cloudxns.conf 文件內容</p>
<pre><code>API_KEY=&quot;YOUR_API_KEY&quot;
SECRET_KEY=&quot;YOUR_SECRET_KEY&quot;
DOMAIN=&quot;example.com&quot;
CERT_DOMAINS=&quot;example.com www.example.com im.example.com&quot;
</code></pre><p>修改其中的 API_KEY 及 SECRET_KEY 爲您的 <a href="https://www.cloudxns.net/AccountManage/apimanage.html" target="_blank" rel="external">cloudxns api key</a> ，修改 DOMAIN 爲你的根域名，</p>
<p>修改 CERT_DOMAINS 爲您要籤的域名列表</p>
<p>運行</p>
<pre><code>./le-cloudxns.sh cloudxns.conf
</code></pre><p>最後生成的文件在當前目錄的 certs 目錄下，然後使用 nginx 加載ssl_certificate字段的fullchain.pem 和 ssl_certificate_key字段的privkey.pem;</p>
<p>cron 定時任務</p>
<p>每兩個月自動更新一次證書，可以在 le-cloudxns.sh 腳本最後加入 service nginx reload 等重新加載服務。</p>
<pre><code>* * * */2 * /etc/nginx/le-cloudxns.sh /etc/nginx/le-cloudxns.conf &gt;&gt; /var/log/le-cloudxns.log 2&gt;&amp;1
</code></pre><p>其他問題見 <a href="http://v2ex.com/t/260965" target="_blank" rel="external">http://v2ex.com/t/260965</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ky0n.xyz/ngx-http-google-filter-module/" data-id="cim66hhzz00272z5f30e31t76" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/google-nginx-encrypt/">google nginx encrypt</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/luotianyi-chrome-theme/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          洛天依 Chrome 主题
        
      </div>
    </a>
  
  
    <a href="/sleep-tight-psp/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Sleep Tight, PSP.</div>
    </a>
  
</nav>

  
</article>


</section>
      </div>
      <footer id="footer">
  
        <div class="outer">
          <div id="footer-info" class="inner">
            Copyleft
            2016
              <br> #freeandopen
              <br>This site is licensed under a <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons BY-NC-SA 4.0</a>
          </div>
          <script>
            (function(i, s, o, g, r, a, m) {
              i['GoogleAnalyticsObject'] = r;
              i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
              }, i[r].l = 1 * new Date();
              a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
              a.async = 1;
              a.src = g;
              m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
            ga('create', 'UA-70500040-1', 'auto', {'allowLinker': true});
            ga('require', 'linker');
            ga('linker:autoLink', ['blog.akarin.xyz']);
            ga('send', 'pageview');
          </script>
          <script src="../console.js" type="text/javascript"></script>
        </div>
        </div>
        </div>
</footer>

    </div>
    

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/scrollReveal.js/0.1.2/scrollReveal.min.js"></script>

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script>
  window.scrollReveal = new scrollReveal();
</script>

<script src="/js/script.js"></script>

  </div>
</body>
</html>
